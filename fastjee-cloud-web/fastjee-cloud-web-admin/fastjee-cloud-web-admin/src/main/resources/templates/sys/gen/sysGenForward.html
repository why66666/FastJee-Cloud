<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>FastJee-Cloud | 正向生成</title>
    <link th:href="@{/plugins/ckeditor/plugins/codesnippet/lib/highlight/styles/zenburn.css}" rel="stylesheet">
    <div th:replace="common/table_head :: table_head"></div>
</head>
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">
    <!--Header-->
    <div th:replace="common/common_mainHeader :: common_mainHeader"></div>
    <!--Sidebar-->
    <div th:replace="common/common_mainSidebar :: common_mainSidebar"></div>

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h1>
                代码生成器
                <small>正向生成</small>
            </h1>
            <ol class="breadcrumb">
                <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
                <li class="active">正向生成</li>
            </ol>
        </section>

        <!-- Main content -->
        <section class="content">
            <div id="alert" class="alert alert-success alert-dismissible col-md-12 col-sm-12 col-xs-12"
                 style="display: none">
                <button type="button" class="close" onclick="$('#alert').hide('fast')">×</button>
                <h4 id="msg"></h4>
                <span id="msgContent"></span>
            </div>


            <!-- row -->
            <div class="row">
                <div class="col-md-12">
                    <!-- The time line -->
                    <ul class="timeline">
                        <!-- timeline time label -->
                        <li class="time-label">
                  <span class="bg-black">
                    正向代码生成器流程
                  </span>
                        </li>
                        <!-- /.timeline-label -->
                        <!-- timeline item -->
                        <li>
                            <i class="fa  fa-database bg-black"></i>

                            <div class="timeline-item">

                                <h3 class="timeline-header">第一步：创建业务数据库表</h3>
                                <div id="first">
                                    <form class="form-horizontal" id="firstForm">
                                        <div class="timeline-body" style="margin: 30px">

                                            <div class="form-group">
                                                <label for="inputTitil" class="col-sm-2 control-label">业务名</label>
                                                <div class="col-sm-7">
                                                    <input type="text" class="form-control required" id="inputTitil"
                                                           placeholder="输入要创建的业务名（系统会根据这里输入的业务名，生成前端代码时展示）">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="inputTableName" class="col-sm-2 control-label">业务表名</label>
                                                <div class="col-sm-7">
                                                    <input type="text" class="form-control required" id="inputTableName"
                                                           placeholder="输入要创建的业务表名称（自动加前缀sev_）">
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                    <div class="timeline-footer">
                                        <a class="btn btn-primary btn-xs" id="toColumn">下一步</a>
                                    </div>
                                </div>

                            </div>
                        </li>
                        <!-- END timeline item -->
                        <!-- timeline item -->
                        <li>
                            <i class="fa fa-th-list bg-black"></i>

                            <div class="timeline-item">
                                <h3 class="timeline-header">第二步：为业务表<span id="showTableName"
                                                                          style="display: none"></span>添加字段</h3>
                                <div id="addColumn" style="display: none">
                                    <div style="margin: 12px">
                                        <table id="dataTable" class="table table-bordered table-hover"
                                               style="width: 100%">
                                            <thead>
                                            <tr>
                                                <th>字段名</th>
                                                <th>字段描述</th>
                                                <th>数据类型</th>
                                                <th>表格展示</th>
                                                <th>表单展示</th>
                                                <th>操作</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="timeline-footer" style="padding: 10px;">
                                        <a class="btn btn-default btn-xs" id="toFirst">上一步</a>
                                        <a class="btn btn-primary btn-xs" id="toGen">下一步</a>
                                    </div>
                                </div>
                            </div>
                        </li>
                        <!-- END timeline item -->
                        <!-- timeline item -->
                        <li>
                            <i class="fa fa-flash bg-black"></i>

                            <div class="timeline-item">

                                <h3 class="timeline-header">第三步：加载代码生成器</h3>
                                <div id="third" style="display: none">
                                    <div class="timeline-body" style="margin: 50px">
                                        请确认以上信息正确后，点击下面按钮执行创建数据库与代码生成。
                                    </div>
                                    <div class="timeline-footer">
                                        <a class="btn btn-default btn-flat btn-xs" type="button" id="toSecond">上一步</a>
                                        <a class="btn btn-warning btn-flat btn-xs" type="button" id="codeGen">确认无误，执行代码生成</a>
                                    </div>
                                </div>
                            </div>
                        </li>
                        <!-- END timeline item -->

                        <!--
                                                <li>
                                                    <i class="fa  fa-heartbeat bg-black"></i>

                                                    <div class="timeline-item">

                                                        <h3 class="timeline-header">控制台输出</h3>
                                                        <div class="box-body">
                                                            <form>
                                                                <textarea id="editor1" name="editor1" style="display: none" rows="10" cols="80">

                                                                </textarea>
                                                            </form>

                                                        </div>
                                                    </div>
                                                </li>
                                                 END timeline item -->
                    </ul>
                </div>
                <!-- /.col -->
            </div>
            <!-- /.row -->


        </section>
        <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->


    <!-- Main Footer -->
    <div th:replace="common/common_footer :: common_footer"></div>
    <!-- Control Sidebar -->
    <div th:replace="common/common_controlSidebar :: common_controlSidebar"></div>
    <!-- /.control-sidebar -->

</div>
<!-- ./wrapper -->

<!-- 添加 modal -->
<div id="editModal" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog"
     aria-labelledby="myLargeModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header" id="editModalHeader">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">编辑字段信息</h4>
            </div>

            <form class="form-horizontal" id="formData">
                <input type="hidden" name="keyId">
                <div class="box-body">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">字段名</label>
                        <div class="col-sm-8">
                            <input type="text" name="columnName" class="form-control required" placeholder="如：username">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">字段描述</label>
                        <div class="col-sm-8">
                            <input type="text" name="columnComment" class="form-control required" placeholder="如：用户名">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">数据类型</label>
                        <div class="col-sm-4">
                            <select class="form-control select2" name="dataType" style="width: 100%;">
                                <option>int</option>
                                <option>tinyint</option>
                                <option>float</option>
                                <option>double</option>
                                <option>char</option>
                                <option>varchar</option>
                                <option>datetime</option>
                            </select>
                        </div>
                        <label class="col-sm-1 control-label">长度</label>
                        <div class="col-sm-3">
                            <input type="number" name="characterMaximumLength" class="form-control " placeholder="如：10">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">字段默认值</label>
                        <div class="col-sm-4">
                            <input type="text" name="columnDefault" class="form-control " placeholder="如：0">
                        </div>
                        <label class="col-sm-2 control-label" style="padding-top: 2px">是否允许为空</label>
                        <div class="col-sm-2">
                            <label><input type="checkbox" name="isNullable" class="flat-red form-control"
                                          checked></label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-8 control-label" style="padding-top: 2px">字段数据是否在数据表格中展示(list页表格展示)</label>
                        <div class="col-sm-3">
                            <label><input id="isShowList" type="checkbox" class="flat-red"></label>
                        </div>
                    </div>
                    <div class="form-group" id="listShowForm" style="display: none">
                        <label class="col-sm-2 control-label">表格展示样式</label>
                        <div class="col-sm-8">
                            <select class="form-control select2" name="listShow" style="width: 100%;">
                                <option value="">默认按数据类型匹配</option>
                                <option>text</option>
                                <option>datetime</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">表单样式</label>
                        <div class="col-sm-8">
                            <select class="form-control select2" name="formShow" style="width: 100%;">
                                <option>text</option>
                                <option value="datetime-local">datetime</option>
                                <option>checkbox</option>
                                <option>select</option>
                                <option>number</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 control-label" style="padding-top: 2px">字段是否高级搜索关联字段(list页)</label>
                        <div class="col-sm-1">
                            <label><input type="checkbox" name="searchPlus" class="flat-red"></label>
                        </div>
                        <label class="col-sm-4 control-label" style="padding-top: 2px">字段是否模糊搜索关联字段(list页)</label>
                        <div class="col-sm-1">
                            <label><input type="checkbox" name="fuzzySearch" class="flat-red"></label>
                        </div>
                    </div>
                </div>
            </form>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" id="submitColumn" class="btn btn-default pull-right">确定
                </button>
            </div>
        </div>
    </div>
</div>
<!-- ./添加 modal -->
<!-- 提交提示 modal -->
<div class="modal modal-warning fade" id="submitModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">提示</h4>
            </div>
            <div class="modal-body">
                <p>确认创建数据库表，并生成代码吗？&hellip;</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline pull-left" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-outline" id="submit">确定</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- 删除提示 modal -->
<div class="modal modal-danger fade" id="delModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">提示</h4>
            </div>
            <div class="modal-body">
                <p>确认删除吗？&hellip;</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline pull-left" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-outline" id="doDel">确定</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>


<!--java script-->
<div th:replace="common/table_js :: table_js"></div>

<!-- CK Editor -->
<script th:src="@{/plugins/ckeditor/ckeditor.js}"></script>
<script th:src="@{/plugins/ckeditor/plugins/codesnippet/lib/highlight/highlight.pack.js}"></script>

<!-- page script -->
<script>
    var _dataTable;
    var _idArray;

    var M = function () {
        var del = function (url) {
            var data = {"ids": _idArray.toString()};
            FormAjax.formAjax(url, "Post", data);
            $("#delModal").modal('hide');
        };
        return{
            deleteSingle : function(url,keyId){
                _idArray = new Array();
                _idArray.push(keyId);
                $("#delModal").modal('show');
                // 绑定删除事件
                $("#doDel").bind("click", function () {
                    del(url);
                });
            },
            toDel : function(url){
                return del(url);
            }
        }
    }();

    function initICheck(){
        $('input[type="checkbox"].flat-red, input[type="radio"].flat-red').iCheck({
            checkboxClass: 'icheckbox_flat-green',
            radioClass: 'iradio_flat-green'
    })}

    $(function () {

        //Initialize Select2 Elements
        $('.select2').select2()

        $("#toColumn").click(function () {

            //初始化表单验证
            Validate.init("firstForm");
            //执行验证
            if (!$("#firstForm").valid()) {
                return;
            }


            $("#first").hide('normal');

            $("#showTableName").show('normal').html($("#inputTitil").val());

            $("#addColumn").show('normal');
            //页面初始化
            App.sysGenInit();

            var _columns = [
                {"data": "columnName"},
                {"data": "columnComment"},
                {"data": "columnType"},
                {"data": "listShow"},
                {"data": "formShow"},
                {
                    "data": function (row, type, val, meta) {
                        var deleteUrl = "/sysGen/delete";
                        return'<a onclick="editColumn(' + meta.row + ')" type="button" class="btn btn-sm btn-primary"><i class="fa fa-edit"></i> 编辑</a>&nbsp;&nbsp;&nbsp;' +
                            '<button onclick="M.deleteSingle(\'' + deleteUrl + '\', \'' + row.keyId + '\')" class="btn btn-sm btn-danger"><i class="fa fa-trash-o"></i> 删除</button>';
                    }
                }
            ];
            _dataTable = App.sysGenInitDataTables("/sysGen/getColumns/0/" + $("#inputTableName").val(), _columns);
        });

        $("#submitColumn").click(function () {
            //初始化表单验证
            Validate.init("formData");
            //执行验证
            if (! $("#formData").valid()) {
                $("#formData")[0].reset();
                return;
            }
            //获取表单数据
            var formData = new FormData($("#formData")[0]);
            formData.append("tableName", $("#inputTableName").val());
            var objData = {};
            formData.forEach((value, key) => objData[key] = value);
            //发送请求
            FormAjax.formAjax("/sysGen/saveColumn", "Post", objData);
            $("#editModal").modal('hide');
            $("#formData")[0].reset();
        });





        $('#toGen').click(function () {
            $("#addColumn").hide('normal');
            $("#third").show('normal');
        });

        $("#codeGen").click(function () {
            $("#submitModal").modal('show');
            $("#submit").bind("click", function () {
                var objData = {};
                objData["tableName"] = $("#inputTableName").val();
                objData["titil"] = $("#inputTitil").val();
                FormAjax.formAjax("/sysGen/codeGen/0", "Get", objData);
                $("#submitModal").modal('hide');
            });
            /*$.ajax({
                type: "Get",                             //请求的类型
                url: "/sysGen/sysOut",                  //请求的路径
                success : function (result) {
                    $("#editor1").html('<pre><code>'+result+'</code></pre>');
                    // Replace the <textarea id="editor1"> with a CKEditor
                    // instance, using default configuration.
                    CKEDITOR.replace('editor1');

                    hljs.initHighlightingOnLoad();

                    $('#editor1').show('normal');
                }
            });*/
        });

        $("#toFirst").click(function () {
            $("#addColumn").hide('normal');
            _dataTable = $('#dataTable').dataTable();
            _dataTable.fnClearTable(); //清空一下table
            _dataTable.fnDestroy(); //还原初始化了的datatable
            $("#showTableName").hide('normal');
            $("#first").show('normal');
        });

        $("#toSecond").click(function () {
            $("#addColumn").show('normal');
            $("#showTableName").show('normal').html($("#inputTitil").val());
            $("#third").hide('normal');
        })

    });

    function checkChange() {
        $("#isShowList").on('ifChecked', function () {
            $("#listShowForm").show();
        }).on('ifUnchecked', function () {
            $("#listShowForm").hide();
        });
    }


    function showEditModal(row) {
        $("#formData")[0].reset();
        initICheck();
        $("#editModal").modal("show");
        checkChange();
    }

    function editColumn(row) {
        var data = _dataTable.rows(row).data()[0];
        $('input[name=columnName]').val(data.columnName);
        $('input[name=keyId]').val(data.keyId);
        $('input[name=columnComment]').val(data.columnComment);
        $('input[name=dataType]').find('option[text=' + data.dataType + ']').attr("selected", true);
        $('input[name=formShow]').find('option[text=' + data.formShow + ']').attr("selected", true);
        $('input[name=characterMaximumLength]').val(data.characterMaximumLength);
        $('input[name=columnDefault]').val(data.columnDefault);
        if (data.listShow !== null && data.listShow !== "") {
            $("#isShowList").iCheck('check');
            $('input[name=listShow]').find('option[text=' + data.listShow + ']').attr("selected", true).show();
        }
        if (data.isNullable === "on") {
            $('input[name=isNullable]').iCheck('check');
        }
        if (data.searchPlus === "on") {
            $('input[name=searchPlus]').iCheck('check');
        }
        if (data.fuzzySearch === "on") {
            $('input[name=fuzzySearch]').iCheck('check');
        }
        $("#editModal").modal("show");
        initICheck();
        checkChange();
    }


</script>
</body>
</html>
